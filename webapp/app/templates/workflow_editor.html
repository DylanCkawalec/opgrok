<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workflow Editor - OPGROK</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    .editor-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .editor-header {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      color: white;
    }
    .editor-main {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }
    .workflow-canvas {
      background: var(--bg-primary);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      min-height: 500px;
    }
    .node-card {
      background: var(--bg-secondary);
      border: 2px solid var(--primary);
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
      transition: all 0.2s;
    }
    .node-card:hover {
      border-color: #10b981;
      transform: translateX(4px);
    }
    .connection-line {
      color: #10b981;
      font-size: 1.2em;
      margin: 8px 0;
      padding-left: 20px;
    }
    .editor-sidebar {
      background: var(--bg-primary);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    .action-btn {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div class="editor-container">
    <div class="editor-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1 id="workflow_name" style="margin: 0 0 8px 0;">Loading...</h1>
          <p id="workflow_status" style="margin: 0; opacity: 0.9;">Fetching workflow data...</p>
        </div>
        <a href="/workflows" style="color: white; text-decoration: none; padding: 10px 20px; background: rgba(255,255,255,0.2); border-radius: 8px;">
          ‚Üê Back to Workflows
        </a>
      </div>
    </div>

    <div class="editor-main">
      <!-- Workflow Canvas -->
      <div class="workflow-canvas">
        <!-- Hero Journey Onboarding -->
        <div id="hero_onboarding" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1)); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
          <h2 style="margin: 0 0 12px 0; color: #8b5cf6;">üéØ Your Workflow Journey</h2>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 16px;">
            <div class="journey-step">
              <div class="step-number">1</div>
              <div class="step-title">View Structure</div>
              <div class="step-desc">See all nodes below</div>
            </div>
            <div class="journey-step">
              <div class="step-number">2</div>
              <div class="step-title">Connect Nodes</div>
              <div class="step-desc">Click green button ‚Üí</div>
            </div>
            <div class="journey-step">
              <div class="step-number">3</div>
              <div class="step-title">Chat to Modify</div>
              <div class="step-desc">Use AI assistant ‚Üí</div>
            </div>
            <div class="journey-step">
              <div class="step-number">4</div>
              <div class="step-title">Activate</div>
              <div class="step-desc">Turn it on!</div>
            </div>
          </div>
        </div>
        
        <h2>üìã Workflow Nodes</h2>
        <div id="nodes_container" style="min-height: 200px;"></div>
      </div>
      
      <style>
        .journey-step {
          text-align: center;
          padding: 16px;
          background: rgba(255,255,255,0.05);
          border-radius: 8px;
          border: 1px solid rgba(139, 92, 246, 0.2);
        }
        .step-number {
          width: 40px;
          height: 40px;
          margin: 0 auto 8px;
          background: #8b5cf6;
          color: white;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.2em;
          font-weight: bold;
        }
        .step-title {
          font-weight: 600;
          margin-bottom: 4px;
        }
        .step-desc {
          font-size: 0.85em;
          color: var(--muted);
        }
      </style>

      <!-- Actions Sidebar -->
      <div class="editor-sidebar">
        <button class="action-btn" style="background: #f59e0b; margin-bottom: 16px;" onclick="openInN8N()">
          üåê Open in n8n Editor
        </button>
        
        <h3 style="margin-top: 32px; margin-bottom: 12px;">üí¨ AI Assistant</h3>
        <p style="font-size: 0.9em; color: rgba(255,255,255,0.7); margin-bottom: 16px;">
          Chat to modify schedule, add nodes, or optimize
        </p>
        
        <!-- Action Results -->
        <div id="chat_area" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 16px; max-height: 300px; overflow-y: auto; margin-bottom: 12px;">
          <div style="color: rgba(255,255,255,0.7); font-size: 0.95em;">
            üí° <strong>Action results appear here</strong>
          </div>
        </div>
        
        <!-- Quick Automated Actions -->
        <div style="display: grid; gap: 8px; margin-bottom: 16px;">
          <button onclick="runAutomatedPrompt('connect_all')" style="padding: 14px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
            üîó Auto-Connect Nodes
          </button>
          <button onclick="runAutomatedPrompt('fill_missing')" style="padding: 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
            üìù Fill Parameters
          </button>
          <button onclick="runAutomatedPrompt('optimize')" style="padding: 14px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
            ‚ö° Optimize All
          </button>
        </div>
        
        <!-- Manual Chat (simplified) -->
        <details style="margin-top: 16px;">
          <summary style="cursor: pointer; padding: 8px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; font-weight: 600;">
            üí¨ Advanced: Custom Modifications
          </summary>
          <div style="margin-top: 12px;">
            <input id="chat_input" type="text" placeholder="Custom modification..." style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid rgba(139, 92, 246, 0.3); background: rgba(0,0,0,0.3); color: white; margin-bottom: 8px;" />
            <button onclick="sendMessage()" style="width: 100%; padding: 10px; background: #8b5cf6; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">
              Send Custom Request
            </button>
          </div>
        </details>
      </div>
    </div>
  </div>

  <script>
    // Extract workflow ID from URL: /workflows/{id}/editor
    const pathParts = window.location.pathname.split('/');
    const workflowId = pathParts[pathParts.length - 2];  // Get ID before '/editor'
    let workflowData = null;
    
    console.log('Workflow ID:', workflowId);

    async function loadWorkflow() {
      try {
        console.log('Loading workflow:', workflowId);
        const res = await fetch(`/api/n8n/workflows/${workflowId}`);
        
        if (!res.ok) {
          throw new Error(`Failed to load: ${res.status}`);
        }
        
        const data = await res.json();
        console.log('Workflow data:', data);
        workflowData = data;
        
        // Update header
        document.getElementById('workflow_name').textContent = data.name;
        document.getElementById('workflow_status').textContent = `${data.nodes?.length || 0} nodes, ${Object.keys(data.connections || {}).length} connections`;
        
        // Render nodes
        renderNodes(data);
        
      } catch (e) {
        document.getElementById('workflow_name').textContent = 'Error Loading Workflow';
        document.getElementById('workflow_status').textContent = e.message;
      }
    }

    function renderNodes(workflow) {
      const container = document.getElementById('nodes_container');
      const nodes = workflow.nodes || [];
      const connections = workflow.connections || {};
      
      container.innerHTML = '<div style="color: var(--muted); margin-bottom: 16px;">Click nodes to see details</div>';
      
      nodes.forEach((node, index) => {
        const nodeCard = document.createElement('div');
        nodeCard.className = 'node-card';
        nodeCard.onclick = () => selectNode(node);
        
        const nodeType = node.type.replace('n8n-nodes-base.', '');
        const hasConnections = connections[node.id] && connections[node.id].main[0].length > 0;
        
        nodeCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong style="font-size: 1.1em;">${node.name}</strong>
              <div style="color: var(--muted); font-size: 0.9em; margin-top: 4px;">${nodeType}</div>
            </div>
            <div style="color: ${hasConnections ? '#10b981' : '#f59e0b'}; font-size: 1.5em;">
              ${hasConnections ? 'üîó' : '‚ö†Ô∏è'}
            </div>
          </div>
        `;
        
        container.appendChild(nodeCard);
        
        // Show connections
        if (hasConnections) {
          const connLine = document.createElement('div');
          connLine.className = 'connection-line';
          const targets = connections[node.id].main[0];
          const targetNames = targets.map(t => {
            const targetNode = nodes.find(n => n.id === t.node);
            return targetNode ? targetNode.name : t.node;
          }).join(', ');
          connLine.textContent = `‚Üì connects to: ${targetNames}`;
          container.appendChild(connLine);
        }
      });
    }

    function selectNode(node) {
      alert(`Node: ${node.name}\nType: ${node.type}\nID: ${node.id}\n\nParameters:\n${JSON.stringify(node.parameters, null, 2)}`);
    }

    async function connectAllNodes() {
      try {
        const res = await fetch(`/api/n8n/workflows/${workflowId}/connect-all`, { method: 'POST' });
        const data = await res.json();
        
        addChatMessage('System', `‚úÖ Connected ${data.connections_added || 0} nodes!`);
        await loadWorkflow();  // Refresh
      } catch (e) {
        addChatMessage('Error', e.message);
      }
    }

    async function analyzeWorkflow() {
      try {
        const res = await fetch(`/api/n8n/workflows/${workflowId}/analyze`);
        const data = await res.json();
        
        addChatMessage('Analysis', data.report);
      } catch (e) {
        addChatMessage('Error', e.message);
      }
    }

    function openInN8N() {
      window.open(`http://localhost:5678/workflow/${workflowId}`, '_blank');
    }

    async function activateWorkflow() {
      try {
        await fetch(`/api/n8n/workflows/${workflowId}/activate`, { method: 'POST' });
        addChatMessage('System', '‚úÖ Workflow activated!');
        await loadWorkflow();
      } catch (e) {
        addChatMessage('Error', e.message);
      }
    }

    // Automated prompt templates that ACTUALLY WORK
    const automatedPrompts = {
      connect_all: `For the n8n workflow "${workflowData?.name || 'current workflow'}": Analyze all unconnected nodes and connect them in the optimal sequence based on their types. Connect triggers to processors, processors in logical order, and final processors to outputs. Use n8n API to update connections.`,
      
      fill_missing: `For the n8n workflow "${workflowData?.name || 'current workflow'}": Identify all nodes with missing or placeholder parameters. Fill them with intelligent defaults based on node type and workflow purpose. Update via n8n API.`,
      
      optimize: `For the n8n workflow "${workflowData?.name || 'current workflow'}": Analyze the entire workflow structure, connections, and parameters. Suggest and apply optimizations for performance, error handling, and reliability. Update via n8n API.`
    };
    
    async function runAutomatedPrompt(type) {
      // ACTUALLY EXECUTE, don't just chat about it!
      
      if (type === 'connect_all') {
        await connectAllNodes();
      } else if (type === 'fill_missing') {
        await fillMissingParameters();
      } else if (type === 'optimize') {
        await optimizeWorkflow();
      }
    }
    
    async function fillMissingParameters() {
      addChatMessage('System', 'üîç Scanning for missing parameters...');
      
      try {
        const analysis = await fetch(`/api/n8n/workflows/${workflowId}/analyze`).then(r => r.json());
        const gaps = analysis.analysis;
        
        if (!gaps.missing_parameters || gaps.missing_parameters.length === 0) {
          addChatMessage('System', '‚úÖ All parameters already configured!');
          return;
        }
        
        addChatMessage('System', `Found ${gaps.missing_parameters.length} missing parameters. Filling with AI...`);
        
        // TODO: Call AI to fill parameters
        // For now, show what needs filling
        gaps.missing_parameters.forEach(item => {
          addChatMessage('System', `üìù ${item.node_name}: needs ${item.missing}`);
        });
        
      } catch (e) {
        addChatMessage('Error', e.message);
      }
    }
    
    async function optimizeWorkflow() {
      addChatMessage('System', '‚ö° Optimizing workflow...');
      
      try {
        // Call analyze first
        const analysis = await fetch(`/api/n8n/workflows/${workflowId}/analyze`).then(r => r.json());
        
        addChatMessage('System', `Analysis:\n${analysis.report}`);
        
        // Auto-connect if needed
        if (analysis.analysis.unconnected_nodes > 0) {
          await connectAllNodes();
        }
        
        addChatMessage('System', '‚úÖ Workflow optimized!');
        
      } catch (e) {
        addChatMessage('Error', e.message);
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chat_input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      sendMessageWithContext(message, false);
    }

    async function sendMessageWithContext(message, isAutomated) {
      if (!isAutomated) {
        addChatMessage('You', message);
      }
      
      addChatMessage('Assistant', 'ü§î Analyzing your workflow...');

      try {
        // Build rich context about THIS workflow
        const workflowContext = workflowData ? `
YOU ARE EDITING THIS SPECIFIC N8N WORKFLOW:
Workflow: ${workflowData.name}
ID: ${workflowData.id}
Nodes: ${workflowData.nodes?.length || 0}

NODES IN THIS WORKFLOW:
${workflowData.nodes?.map((n, i) => `${i+1}. ${n.name} (${n.type.replace('n8n-nodes-base.', '')})`).join('\n')}

CONNECTIONS:
${Object.entries(workflowData.connections || {}).map(([src, data]) => {
  const srcNode = workflowData.nodes.find(n => n.id === src);
  const targets = data.main[0].map(t => {
    const targetNode = workflowData.nodes.find(n => n.id === t.node);
    return targetNode ? targetNode.name : t.node;
  });
  return `${srcNode?.name || src} ‚Üí ${targets.join(', ')}`;
}).join('\n')}

User wants: ${message}

Respond with SPECIFIC actions for THIS workflow.
` : 'No workflow loaded';

        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            model: 'grok-4-fast-non-reasoning',
            temperature: 0.3,
            max_tokens: 1536,
            system_prompt: `You are an n8n workflow editor AI. ${workflowContext}

When user asks to modify, connect, or update:
1. Reference specific nodes by name from the workflow above
2. Be concrete about what to change
3. Explain clearly what will happen

Example: "I'll update the 'Schedule Hourly Trigger' node's cronExpression to run every 30 minutes instead of hourly."

Be helpful and specific to THIS workflow.`
          })
        });

        const data = await res.json();
        
        // Remove "thinking" message
        const chatArea = document.getElementById('chat_area');
        const thinkingMsg = Array.from(chatArea.children).find(el => el.textContent.includes('ü§î'));
        if (thinkingMsg) thinkingMsg.remove();
        
        addChatMessage('Assistant', data.assistant);

        if (data.workflow_modified) {
          await loadWorkflow();  // Refresh if modified
        }
      } catch (e) {
        addChatMessage('Error', e.message);
      }
    }

    function addChatMessage(role, content) {
      const chat = document.getElementById('chat_area');
      const colors = {
        'You': '#60a5fa',
        'Assistant': '#10b981',
        'System': '#8b5cf6',
        'Error': '#ef4444',
        'Analysis': '#3b82f6'
      };

      chat.innerHTML += `
        <div style="margin-bottom: 12px;">
          <strong style="color: ${colors[role] || 'white'};">${role}:</strong>
          <div style="margin-top: 4px; white-space: pre-wrap;">${content}</div>
        </div>
      `;
      chat.scrollTop = chat.scrollHeight;
    }

    // Enter to send
    document.getElementById('chat_input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Load on page load
    loadWorkflow();
  </script>
</body>
</html>
